<!doctype html>
<html lang="nl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Zever — basic site met login & visitor logging</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#f6fff2;color:#111;margin:0}
  header{background:#2f8f4a;color:#fff;padding:16px;text-align:center}
  main{padding:18px;max-width:1000px;margin:20px auto}
  .btn{display:inline-block;padding:8px 12px;background:#1b5e20;color:#fff;border-radius:6px;text-decoration:none;margin:6px}
  .small{font-size:13px;color:#333}
  .card{background:#fff;padding:14px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.08);margin:12px 0}
  #adminPanel{display:none}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}
  input[type="password"]{padding:8px;border-radius:6px;border:1px solid #ccc}
  .danger{background:#b71c1c}
  footer{padding:12px;text-align:center;color:#666;font-size:13px}
  .note{font-size:13px;color:#555}
</style>
</head>
<body>

<header>
  <h1>Zever — demo site</h1>
  <div class="small">Eenvoudige demo: bezoek-log + admin tab (1 bestand)</div>
</header>

<main>
  <div class="card">
    <h2>Welkom</h2>
    <p class="note">Deze site registreert bezoekers (tijd, apparaat, IP). Alleen jij ziet de admin-tab na inloggen.</p>
    <div>
      <a class="btn" href="#" onclick="showHome()">Home</a>
      <a class="btn" href="#" onclick="showAdminLogin()">Admin</a>
      <a class="btn" href="#" id="clearLocalBtn" onclick="clearLocal()">Clear local logs</a>
    </div>
  </div>

  <section id="home" class="card">
    <h3>Home</h3>
    <p>Deze pagina is de publieke pagina die iedereen ziet.</p>
    <p class="small">Je kunt dit bestand aanpassen. Gaat naar GitHub Pages om te publiceren.</p>
  </section>

  <section id="adminLogin" class="card" style="display:none">
    <h3>Admin login</h3>
    <p><label>Wachtwoord: <input type="password" id="adminPass"></label>
    <button class="btn" onclick="tryLogin()">Login</button></p>
    <p class="note">Admin wachtwoord staat in het bestand; verander het in de code (variabele ADMIN_PASS).</p>
  </section>

  <section id="adminPanel" class="card">
    <h3>Admin paneel</h3>
    <p class="note">Alle bezoekers (remote via Firebase indien geconfigureerd) of lokaal (fallback) worden hier getoond.</p>

    <div style="margin:10px 0">
      <button class="btn" onclick="refreshLogs()">Refresh</button>
      <button class="btn" onclick="downloadLogs()">Download CSV</button>
      <button class="btn danger" onclick="wipeLogs()">Wipe all logs (local or remote)</button>
    </div>

    <div id="logsContainer" class="card" style="padding:8px;overflow:auto;max-height:360px">
      <table id="logsTable">
        <thead><tr><th>Tijd (UTC)</th><th>IP</th><th>User-Agent</th><th>Source</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

  </section>
</main>

<footer>
  <div class="small">Demo — niet productieklaar. Gebruik verantwoordelijk.</div>
</footer>

<script>
/* ------------------ CONFIGURATION ------------------
 * Zet hier je admin wachtwoord. Dit staat in de HTML: niet veilig.
 * Als je Firebase logs wilt gebruiken: vul firebaseConfig hieronder en zet USE_FIREBASE = true.
 */
const ADMIN_PASS = "change_this_password"; // <- verander dit
const USE_FIREBASE = false; // true = stuur logs naar Firebase (volg instructies verderop)
const FIREBASE_CONFIG = {
  // voorbeeld (leeg): kopieer je eigen Firebase config object hier als je USE_FIREBASE=true
  // apiKey: "...", authDomain: "...", databaseURL: "...", projectId: "...", storageBucket: "...",
  // messagingSenderId: "...", appId: "..."
};

/* ------------------ einde config ------------------ */

let logs = []; // local cache of logs
let isAdmin = false;

// helper uuid
function uid(len=10){
  return Date.now().toString(36) + Math.random().toString(36).substring(2,2+len);
}

/* visitor logging: build a record and push to storage (firebase or localStorage) */
async function registerVisit(){
  const rec = {
    id: uid(6),
    time: new Date().toISOString(),
    ua: navigator.userAgent || "",
    ip: "",
    source: "local" // will be overwritten to 'firebase' if pushed there
  };

  // try to fetch public IP (may fail due to CORS or network)
  try{
    const r = await fetch('https://api.ipify.org?format=json');
    if(r.ok){
      const j = await r.json();
      rec.ip = j.ip || "";
    }
  }catch(e){
    // ignore
  }

  if(USE_FIREBASE && typeof firebase !== 'undefined' && firebase.database){
    try{
      const db = firebase.database();
      const ref = db.ref('visitors');
      const newRef = ref.push();
      await newRef.set(rec);
      rec.source = 'firebase';
    }catch(e){
      console.warn('Firebase push failed', e);
      rec.source = 'local';
      saveLocalRecord(rec);
    }
  } else {
    saveLocalRecord(rec);
  }

  console.log('visit registered', rec);
}

function saveLocalRecord(rec){
  // read from localStorage
  let a = JSON.parse(localStorage.getItem('visitor_logs') || '[]');
  a.push(rec);
  localStorage.setItem('visitor_logs', JSON.stringify(a));
  logs = a;
}

// Admin functions
function showHome(){ document.getElementById('home').style.display='block'; document.getElementById('adminLogin').style.display='none'; document.getElementById('adminPanel').style.display='none'; }
function showAdminLogin(){ document.getElementById('home').style.display='none'; document.getElementById('adminLogin').style.display='block'; document.getElementById('adminPanel').style.display='none'; }
function showAdminPanel(){ document.getElementById('home').style.display='none'; document.getElementById('adminLogin').style.display='none'; document.getElementById('adminPanel').style.display='block'; }

function tryLogin(){
  const pw = document.getElementById('adminPass').value;
  if(pw === ADMIN_PASS){
    isAdmin = true;
    showAdminPanel();
    refreshLogs();
  } else {
    alert('Onjuist wachtwoord');
  }
}

function getLocalLogs(){
  return JSON.parse(localStorage.getItem('visitor_logs')||'[]');
}

async function getFirebaseLogs(){
  if(typeof firebase === 'undefined' || !firebase.database) return [];
  const db = firebase.database();
  const snap = await db.ref('visitors').once('value');
  const obj = snap.val() || {};
  const arr = Object.keys(obj).map(k => obj[k]);
  return arr;
}

async function refreshLogs(){
  let combined = [];
  if(USE_FIREBASE && typeof firebase !== 'undefined'){
    try{
      const f = await getFirebaseLogs();
      combined = combined.concat(f);
    }catch(e){
      console.warn('get firebase failed', e);
    }
  }
  combined = combined.concat(getLocalLogs());
  // sort by time desc
  combined.sort((a,b)=> (b.time||'').localeCompare(a.time||''));
  logs = combined;
  renderLogs();
}

function renderLogs(){
  const tbody = document.querySelector('#logsTable tbody');
  tbody.innerHTML = '';
  logs.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(r.time||'')}</td><td>${escapeHtml(r.ip||'')}</td><td style="max-width:360px;overflow:hidden">${escapeHtml(r.ua||'')}</td><td>${escapeHtml(r.source||'')}</td>`;
    tbody.appendChild(tr);
  });
}

// export CSV
function downloadLogs(){
  if(!isAdmin){ alert('Login als admin'); return; }
  if(!logs || logs.length===0){ alert('Geen logs'); return; }
  let csv = 'time,ip,userAgent,source\n';
  logs.forEach(r=>{
    csv += `${(r.time||'')},${(r.ip||'')},${(r.ua||'').replace(/,/g,';')},${(r.source||'')}\n`;
  });
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'visitor_logs.csv'; document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

// wipe logs
async function wipeLogs(){
  if(!confirm('Weet je zeker? Verwijdert alle lokale logs (en remote als geconfigureerd).')) return;
  localStorage.removeItem('visitor_logs');
  if(USE_FIREBASE && typeof firebase !== 'undefined'){
    try{
      await firebase.database().ref('visitors').remove();
    }catch(e){ console.warn(e) }
  }
  logs = [];
  renderLogs();
}

// clear local only (quick)
function clearLocal(){
  if(confirm('Verwijder lokale logs op deze browser?')){ localStorage.removeItem('visitor_logs'); alert('Local logs verwijderd.'); }
}

/* tiny escape helper */
function escapeHtml(s){ if(!s) return ''; return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* CSV helper above, etc. */

/* ------------------ OPTIONAL: Firebase init ------------------
 If you want to centralize logs, create a free Firebase project:
 1) Go to https://console.firebase.google.com/ and create project
 2) Under "Build" choose Realtime Database, create database, start in test mode (open)
 3) In Project Settings -> Your apps -> add a web app -> copy the config object
 4) Paste the config into FIREBASE_CONFIG at top and set USE_FIREBASE = true
 The script below will initialize Firebase and log visits there.
*/
async function initFirebaseIfNeeded(){
  if(!USE_FIREBASE) return;
  if(!FIREBASE_CONFIG || !FIREBASE_CONFIG.apiKey){ console.warn('Firebase config missing'); return; }

  // load firebase scripts dynamically
  if(typeof firebase === 'undefined'){
    await loadScript('https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js');
    await loadScript('https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js');
  }
  try{
    firebase.initializeApp(FIREBASE_CONFIG);
    console.log('firebase init ok');
  }catch(e){
    console.warn('firebase init failed', e);
  }
}

function loadScript(src){
  return new Promise((resolve, reject)=>{
    const s = document.createElement('script');
    s.src = src; s.onload = resolve; s.onerror = reject;
    document.head.appendChild(s);
  });
}

/* ------------------ start ------------------ */
(async function(){
  showHome();
  await initFirebaseIfNeeded();
  await registerVisit();
})();
</script>

</body>
</html>
